<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Collabsphere - Create & Manage Projects</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* keep your existing styles unchanged */
    .add-btn { background-color: #4b6cb7; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-bottom: 1rem; }
    .add-btn:hover { background-color: #3a56a0; }
    .hidden { display: none; }
    form { background: #fff; border-radius: 8px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 1rem; width: 100%; max-width: 500px; }
    input, textarea { width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button[type="submit"] { background-color: #4b6cb7; color: white; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer; }
    button[type="submit"]:hover { background-color: #3a56a0; }
    .close-btn { background: #c0392b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
    .close-btn:hover { background: #a93226; }
  </style>
</head>
<body>
  <header>
    <h1>Collabsphere</h1>
    <nav>
      <button id="sidebarToggle">☰</button>
    </nav>
  </header>

  <aside id="sidebar">
    <a href="profile.html">My Profile</a>
    <a href="create-project.html">Create Project</a>
    <a href="home.html">Search Projects</a>
    <a href="notifications.html" id="notificationLink">Notifications</a>
    <a href="#" id="adminLink">Admin Panel</a>
    <button onclick="logout()">Logout</button>
  </aside>

  <main>
    <h2>Explore the Projects!</h2>
    <button id="createProjectBtn" class="add-btn">+ Create Project</button>

    <div id="createProjectForm" class="hidden">
      <h3>Create New Project</h3>
      <form id="projectForm">
        <input type="text" id="title" placeholder="Project Title" required><br>
        <textarea id="description" placeholder="Project Description" required></textarea><br>
        <input type="number" id="required_people" placeholder="No. of People Required" required><br>
        <input type="date" id="deadline"><br>
        <input type="number" id="amount" placeholder="Payment (optional)"><br>
        <button type="submit">Submit for Approval</button>
      </form>
    </div>

    <hr>
    <div id="projectsList"></div>
  </main>

  <script>
    const BASE_URL = 'http://localhost:3000';

    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebarToggle');
    const adminLink = document.getElementById('adminLink');
    const createBtn = document.getElementById('createProjectBtn');
    const formSection = document.getElementById('createProjectForm');
    const form = document.getElementById('projectForm');
    const listContainer = document.getElementById('projectsList');

    // Sidebar toggle
    toggleBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      sidebar.classList.toggle('show');
    });

    document.addEventListener('click', (e) => {
      if (!sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
        sidebar.classList.remove('show');
      }
    });

    const isAdmin = sessionStorage.getItem('isAdmin') === '1';
    if (!isAdmin) adminLink.style.display = 'none';

    function logout() {
      sessionStorage.clear();
      localStorage.clear();
      window.location.href = 'index.html';
    }

    createBtn.addEventListener('click', () => formSection.classList.toggle('hidden'));

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        title: document.getElementById('title').value.trim(),
        description: document.getElementById('description').value.trim(),
        required_people: document.getElementById('required_people').value.trim(),
        deadline: document.getElementById('deadline').value || null,
        amount: document.getElementById('amount').value || 0
      };

      try {
        const res = await fetch(`${BASE_URL}/api/projects/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });

        const json = await res.json();
        if (json.ok) {
          alert('✅ Project submitted for admin approval!');
          form.reset();
          formSection.classList.add('hidden');
          loadMyProjects();
        } else {
          alert('❌ Error: ' + (json.error || 'Failed to create project.'));
        }
      } catch (err) {
        alert('❌ Network error while creating project.');
      }
    });

    async function loadMyProjects() {
      listContainer.innerHTML = '<p>Loading your projects...</p>';
      try {
        const res = await fetch(`${BASE_URL}/api/projects/all`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load projects');
        const projects = await res.json();

        listContainer.innerHTML = '';
        if (!Array.isArray(projects) || projects.length === 0) {
          listContainer.innerHTML = '<p>No projects available.</p>';
          return;
        }

        projects.forEach(p => {
          const div = document.createElement('div');
          const deadlineText = p.deadline ? `Deadline: ${new Date(p.deadline).toLocaleDateString()}` : 'No Deadline';
          const amountText = p.amount ? `Pay: $${Number(p.amount).toFixed(2)}` : 'Volunteer/Unpaid';
          const statusChip =
            p.status === 'pending'
              ? '<span style="color:orange;">(Pending Approval)</span>'
              : p.status === 'closed'
              ? '<span style="color:red;">(Closed)</span>'
              : '<span style="color:green;">(Approved)</span>';

          div.innerHTML = `
            <h3><a href="project.html?id=${p.id}">${p.title}</a> ${statusChip}</h3>
            <p>${p.description}</p>
            <p>
              Owner: ${p.owner_name || 'You'}<br>
              Contact: ${p.owner_email || 'N/A'}${p.owner_whatsapp ? ' | WhatsApp: ' + p.owner_whatsapp : ''}<br>
              ${deadlineText} | ${amountText}
            </p>
            <button onclick="window.location.href='project.html?id=${p.id}'">View & Apply</button>
            ${
              p.status === 'approved'
                ? `<button class="close-btn" onclick="closeProject(${p.id})">Close Applications</button>`
                : ''
            }
            <hr>
          `;
          listContainer.appendChild(div);
        });
      } catch (err) {
        console.error('Error loading projects:', err);
        listContainer.innerHTML = '<p style="color:red;">❌ Failed to load your projects. Please refresh.</p>';
      }
    }

    async function closeProject(id) {
      if (!confirm('Are you sure you want to stop receiving applications for this project?')) return;

      try {
        const res = await fetch(`${BASE_URL}/api/projects/${id}/close`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        });

        const json = await res.json();
        if (json.ok) {
          alert('✅ Applications closed successfully.');
          loadMyProjects();
        } else {
          alert('❌ Error: ' + (json.error || 'Could not close project.'));
        }
      } catch (err) {
        alert('❌ Network error while closing project.');
      }
    }

    loadMyProjects();
  </script>
</body>
</html>
