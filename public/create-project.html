<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Collabsphere - Create & Manage Projects</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .add-btn { background-color: #4b6cb7; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-bottom: 1rem; }
    .add-btn:hover { background-color: #3a56a0; }
    .hidden { display: none; }
    form { background: #fff; border-radius: 8px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 1rem; max-width: 500px; }
    input, textarea { width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button[type="submit"] { background-color: #4b6cb7; color: white; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer; }
    button[type="submit"]:hover { background-color: #3a56a0; }
    .close-btn { background: #c0392b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
    .close-btn:hover { background: #a93226; }
    .project-card { border:1px solid #ccc; padding:10px 12px; margin-bottom:12px; border-radius:6px; }
    .status-chip { font-weight:bold; margin-left:6px; }
  </style>
</head>
<body>
<header>
  <h1>Collabsphere</h1>
  <nav>
   
  </nav>
</header>

<aside id="sidebar">
  <a href="profile.html">My Profile</a>
  <a href="create-project.html">Create Project</a>
  <a href="home.html">Search Projects</a>
  <a href="notifications.html" id="notificationLink">Notifications</a>
  <a href="#" id="adminLink">Admin Panel</a>
  <button onclick="logout()">Logout</button>
</aside>

<main>
  <h2>Create & Explore Projects</h2>
  <button id="createProjectBtn" class="add-btn">+ Create Project</button>

  <div id="createProjectForm" class="hidden">
    <h3>Create New Project</h3>
    <form id="projectForm">
      <input type="text" id="title" placeholder="Project Title" required><br>
      <textarea id="description" placeholder="Project Description" required></textarea><br>
      <input type="number" id="required_people" placeholder="No. of People Required" required><br>
      <input type="date" id="deadline"><br>
      <input type="number" id="amount" placeholder="Payment (optional)"><br>
      <button type="submit">Submit for Approval</button>
    </form>
  </div>

  <hr>
  <div id="projectsList"></div>
</main>

<script>
const BASE_URL = 'http://localhost:3000';

const createBtn = document.getElementById('createProjectBtn');
const formSection = document.getElementById('createProjectForm');
const form = document.getElementById('projectForm');
const listContainer = document.getElementById('projectsList');
const adminLink = document.getElementById('adminLink');

createBtn.addEventListener('click', () => formSection.classList.toggle('hidden'));

const isAdmin = sessionStorage.getItem('isAdmin') === '1';
if (!isAdmin) adminLink.style.display = 'none';

function logout() {
  sessionStorage.clear();
  localStorage.clear();
  window.location.href = 'index.html';
}

form.addEventListener('submit', async e => {
  e.preventDefault();
  const data = {
    title: document.getElementById('title').value.trim(),
    description: document.getElementById('description').value.trim(),
    required_people: document.getElementById('required_people').value.trim(),
    deadline: document.getElementById('deadline').value || null,
    amount: document.getElementById('amount').value || 0
  };
  try {
    const res = await fetch(`${BASE_URL}/projects/create`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(data)
    });
    const json = await res.json();
    if (json.ok) {
      alert('✅ Project submitted for approval!');
      form.reset();
      formSection.classList.add('hidden');
      loadProjects();
    } else {
      alert('❌ Error: ' + (json.error || 'Failed to create project.'));
    }
  } catch(err) {
    alert('❌ Network error. Check server and CORS.');
  }
});

async function loadProjects() {
  listContainer.innerHTML = '<p>Loading projects...</p>';
  
  // Get current user
  let currentUser = null;
  try {
    const userRes = await fetch(`${BASE_URL}/profile/me`, { credentials: 'include' });
    if (userRes.ok) currentUser = await userRes.json();
  } catch(err) {
    console.warn('Could not load current user', err);
  }

  try {
    const res = await fetch(`${BASE_URL}/projects/all`, { credentials: 'include' });
    if (!res.ok) throw new Error('Failed to fetch projects');
    const projects = await res.json();
    listContainer.innerHTML = '';

    if (!projects.length) {
      listContainer.innerHTML = '<p>No projects available.</p>';
      return;
    }

    for (const p of projects) {
      const div = document.createElement('div');
      div.className = 'project-card';
      const statusColor = p.status === 'pending' ? 'orange' : p.status === 'closed' ? 'red' : 'green';

      // ✅ Check if current user is selected
      let joinedBadge = '';
      if (currentUser && p.selectedMembers && p.selectedMembers.some(m => Number(m.user_id) === Number(currentUser.id))) {
        joinedBadge = `<span class="status-chip" style="color:white; background:green; padding:2px 6px; border-radius:4px; margin-left:8px;">Joined</span>`;
      }

      div.innerHTML = `
        <h3><a href="project.html?id=${p.id}">${p.title}</a>
          <span class="status-chip" style="color:${statusColor}">(${p.status})</span>
          ${joinedBadge}
        </h3>
        <p>${p.description}</p>
        <p>Owner: ${p.owner_name || 'You'} | Contact: ${p.owner_email || 'N/A'}<br>
           ${p.deadline ? 'Deadline: ' + new Date(p.deadline).toLocaleDateString() : 'No Deadline'} |
           ${p.amount ? '$' + Number(p.amount).toFixed(2) : 'Volunteer/Unpaid'}</p>
        ${p.status === 'approved' ? `<button class="close-btn" onclick="closeProject(${p.id})">Close Applications</button>` : ''}
      `;
      listContainer.appendChild(div);
    }
  } catch(err) {
    console.error(err);
    listContainer.innerHTML = '<p style="color:red;">❌ Failed to load projects.</p>';
  }
}


async function closeProject(id) {
  if(!confirm('Close applications for this project?')) return;
  try {
    const res = await fetch(`${BASE_URL}/projects/${id}/close`, {
      method:'POST',
      credentials:'include'
    });
    const json = await res.json();
    if(json.ok) alert('Applications closed');
    loadProjects();
  } catch(err) {
    alert('❌ Network error while closing project');
  }
}

loadProjects();
</script>
</body>
</html>
