<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8">
Â  <title>Project â€” Collabsphere</title>
Â  <link rel="stylesheet" href="css/style.css">
Â  <style>
Â  Â  .project-header { display:flex; justify-content:space-between; gap:16px; align-items:center; }
Â  Â  .meta small { color:#666; }
Â  Â  .applicants { margin-top:12px; }
Â  Â  .feedback-list { margin-top:18px; }
Â  Â  .chip { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef6ff; margin-right:6px; margin-bottom:5px; }
    .applicant-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;}
    .applicant-item:last-child { border-bottom: none; }
    .owner-actions button { margin-left: 5px; }
    .applicant-details { font-size: 0.9em; color: #555; margin-top: 5px; }
Â  </style>
</head>
<body>
Â  <header class="header">
Â  Â  <div class="brand">Collabsphere</div>
Â  Â  <nav class="nav-links">
Â  Â  Â  <a href="home.html">Home</a>
Â  Â  Â  <a href="profile.html">Profile</a>
Â  Â  </nav>
Â  </header>

Â  <main class="container">
Â  Â  <div class="main">
Â  Â  Â  <div class="card" id="projectCard">
Â  Â  Â  Â  <div class="project-header">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <h2 id="title">Loading...</h2>
Â  Â  Â  Â  Â  Â  <div class="meta"><small id="owner">â€”</small></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <button id="closeAppBtn" class="danger" style="display:none;">Close Applications</button>
Â  Â  Â  Â  Â  Â  <button id="applyBtn" class="primary">Apply to this Project</button>
Â  Â  Â  Â  Â  Â  <button id="shareBtn" class="ghost">Share</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <hr>

Â  Â  Â  Â  <div id="description">Loading description...</div>
        
        <div class="selected-members card" id="membersCard" style="display:none; margin-top: 15px;">
Â  Â  Â  Â  Â  <h4>Selected Members</h4>
Â  Â  Â  Â  Â  <div id="membersList"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="applicants card" id="applicantsCard" style="display:none;">
Â  Â  Â  Â  Â  <h4>Applicants (<span id="applicantCount">0</span>)</h4>
Â  Â  Â  Â  Â  <div id="applicantsList"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="feedback-list card">
Â  Â  Â  Â  Â  <h4>Feedback</h4>
Â  Â  Â  Â  Â  <div id="feedbackList"></div>

Â  Â  Â  Â  Â  <form id="feedbackForm" style="margin-top:12px;">
Â  Â  Â  Â  Â  Â  <textarea name="message" id="fbMessage" placeholder="Write feedback..." rows="3" style="width:100%;"></textarea>
Â  Â  Â  Â  Â  Â  <button class="primary" type="submit">Send Feedback</button>
Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>

Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <aside class="sidebar">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h4>Project Info</h4>
Â  Â  Â  Â  <p><span class="chip">Status:</span> <span id="statusChip">â€”</span></p>
Â  Â  Â  Â  <p><span class="chip">Required:</span> <span id="slots">â€”</span></p>
        <p><span class="chip">Deadline:</span> <span id="deadlineInfo">â€”</span></p>
        <p><span class="chip">Amount:</span> <span id="amountInfo">â€”</span></p>
Â  Â  Â  Â  <p><span class="chip">Applicants:</span> <span id="appCount">â€”</span></p>
Â  Â  Â  </div>
Â  Â  </aside>
Â  </main>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('id');
    const applyBtn = document.getElementById('applyBtn');
    const shareBtn = document.getElementById('shareBtn');
    const closeAppBtn = document.getElementById('closeAppBtn');
    const feedbackForm = document.getElementById('feedbackForm');
    let currentProjectOwnerId = null;
    let currentUserId = null;


    // Load Project Data
    async function loadProject() {
        if (!projectId) {
            document.getElementById('title').textContent = 'Error: No Project ID specified';
            return;
        }
        
        const res = await fetch(`/api/projects/${projectId}`);
        const data = await res.json();
        
        if (!res.ok) {
            document.getElementById('title').textContent = data.error || 'Project not found';
            return;
        }

        const project = data.project;
        
        document.getElementById('title').textContent = project.title;
        document.getElementById('owner').textContent = `Owner: ${project.owner_name}`;
        document.getElementById('description').innerHTML = project.description.replace(/\n/g, '<br>');
        
        // Populate sidebar info
        document.getElementById('statusChip').textContent = project.status;
        document.getElementById('slots').textContent = project.required_people;
        document.getElementById('appCount').textContent = data.applicantsCount;
        document.getElementById('deadlineInfo').textContent = project.deadline ? new Date(project.deadline).toLocaleDateString() : 'N/A';
        document.getElementById('amountInfo').textContent = `$${Number(project.amount).toFixed(2)}`;
        
        currentProjectOwnerId = project.user_id;

        // Load logged-in user details to check ownership
        const user = await loadCurrentUser(project.user_id);
        
        // Apply Button Logic
        updateApplyButton(project.status, data.myApplicationStatus);

        // Display selected members (visible to selected members and owner)
        displaySelectedMembers(data.selectedMembers);

        // Load Applicants (Only visible to project owner/admin)
        if (user && (user.id === project.user_id || user.is_admin === 1)) {
            loadApplicants(project.id);
            if (user.id === project.user_id && project.status === 'approved') {
                 closeAppBtn.style.display = 'inline-block';
                 closeAppBtn.onclick = handleCloseApplication;
            }
        }

        // Load Feedback
        displayFeedback(data.feedbacks);
    }
    
    // Load logged-in user and check ownership
    async function loadCurrentUser(ownerId) {
        const res = await fetch('/api/profile/me');
        if (res.ok) {
            const user = await res.json();
            currentUserId = user.id;
            // If current user is the owner, show owner-specific cards
            if (currentUserId === ownerId || user.is_admin === 1) {
                document.getElementById('applicantsCard').style.display = 'block';
                document.getElementById('membersCard').style.display = 'block';
            }
            return user;
        }
        return null;
    }

    // Update Apply Button State
    function updateApplyButton(projectStatus, myApplicationStatus) {
        applyBtn.style.display = 'none'; // Hide by default

        if (projectStatus !== 'approved') {
            applyBtn.textContent = 'Applications Closed';
            applyBtn.disabled = true;
            applyBtn.style.display = 'inline-block';
            applyBtn.style.backgroundColor = 'grey';
            return;
        }

        applyBtn.style.display = 'inline-block';

        if (!myApplicationStatus) {
            applyBtn.textContent = 'Apply to this Project';
            applyBtn.onclick = handleApply;
            applyBtn.disabled = false;
            applyBtn.style.backgroundColor = ''; // Use default style
        } else if (myApplicationStatus === 'applied') {
            applyBtn.textContent = 'Application Pending';
            applyBtn.disabled = true;
            applyBtn.style.backgroundColor = 'orange';
        } else if (myApplicationStatus === 'accepted') {
            applyBtn.textContent = 'ðŸŽ‰ You are Selected! Contact Owner for further information';
            applyBtn.disabled = true;
            applyBtn.style.backgroundColor = 'green';
        } else if (myApplicationStatus === 'rejected') {
            applyBtn.textContent = 'Application Rejected';
            applyBtn.disabled = true;
            applyBtn.style.backgroundColor = 'red';
        }
    }
    
    // Display Feedback
    function displayFeedback(feedbacks) {
        const list = document.getElementById('feedbackList');
        list.innerHTML = '';
        if (feedbacks.length === 0) {
            list.innerHTML = '<p>No feedback yet. Be the first!</p>';
            return;
        }
        feedbacks.forEach(f => {
            const div = document.createElement('div');
            div.innerHTML = `<p><strong>${f.from_name}:</strong> ${f.message}</p><small>${new Date(f.created_at).toLocaleString()}</small><hr>`;
            list.appendChild(div);
        });
    }

    // Display Selected Members
    function displaySelectedMembers(members) {
        const list = document.getElementById('membersList');
        list.innerHTML = '';
        if (members.length === 0) {
            list.innerHTML = '<p>No members selected yet.</p>';
            return;
        }
        members.forEach(m => {
            const p = document.createElement('div');
            p.innerHTML = `<p><strong>${m.name}</strong> (${m.email})</p>`;
            list.appendChild(p);
        });
    }

    // Load and Display Applicants (Owner view)
    async function loadApplicants(projectId) {
        const res = await fetch(`/api/projects/${projectId}/applicants`);
        if (!res.ok) {
            document.getElementById('applicantsList').innerHTML = '<p style="color:red;">Error loading applicants.</p>';
            return;
        }
        
        const data = await res.json();
        const list = document.getElementById('applicantsList');
        document.getElementById('applicantCount').textContent = data.applicants.length;
        list.innerHTML = '';

        data.applicants.forEach(app => {
            const div = document.createElement('div');
            div.className = 'applicant-item';
            div.innerHTML = `
                <div>
                    <strong>${app.applicant_name}</strong> (${app.applicant_email}) - Status: ${app.status}
                    <div class="applicant-details">
                        ${app.bio ? `Bio: ${app.bio}<br>` : ''}
                        ${app.whatsapp ? `WhatsApp: ${app.whatsapp}<br>` : ''}
                        ${app.portfolio ? `<a href="${app.portfolio}" target="_blank">Portfolio</a>` : ''}
                    </div>
                </div>
                <div class="owner-actions">
                    <button class="primary" onclick="handleSelection(${projectId}, ${app.user_id}, 'select')">Select</button>
                    <button onclick="handleSelection(${projectId}, ${app.user_id}, 'reject')">Reject</button>
                </div>
            `;
            list.appendChild(div);
        });
    }


    // --- Event Handlers ---

    // Handle Apply button click
    async function handleApply() {
        if (!currentUserId) {
            alert("You must be logged in to apply for a project.");
            return;
        }
        
        if (confirm("Are you sure you want to apply for this project?")) {
            const res = await fetch(`/api/projects/${projectId}/apply`, { method: 'POST' });
            const data = await res.json();
            alert(data.message);
            if (res.ok) {
                loadProject(); 
            }
        }
    }
    
    // Handle Owner Selection/Rejection
    async function handleSelection(projectId, applicantId, action) {
        const endpoint = action === 'select' ? '/api/selection/select' : '/api/selection/reject-applicant';
        
        if (!confirm(`Confirm ${action} for this applicant?`)) return;

        const res = await fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ projectId, applicantId })
        });

        const data = await res.json();
        alert(data.message);
        
        if (res.ok) {
            loadProject();
        }
    }
    
    // Handle Owner Close Application
    async function handleCloseApplication() {
        if (!confirm("Are you sure you want to manually close applications for this project?")) return;
        
        const res = await fetch(`/api/projects/${projectId}/close`, { method: 'POST' });
        const data = await res.json();
        alert(data.message);

        if (res.ok) {
            loadProject();
        }
    }


    // Share button
    shareBtn.addEventListener('click', () => {
        const url = window.location.href;
        navigator.clipboard.writeText(url);
        alert('Project link copied to clipboard!');
    });

    // Feedback submission
    feedbackForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = document.getElementById('fbMessage').value;
        if (!message) {
            alert('Feedback message required.');
            return;
        }
        
        const res = await fetch(`/api/projects/${projectId}/feedback`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });

        const data = await res.json();
        alert(data.message);
        if (res.ok) {
            document.getElementById('fbMessage').value = '';
            loadProject();
        }
    });

    loadProject();
</script>
</body>
</html>