<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Collabsphere - Home</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <h1>Collabsphere</h1>
    <nav>
      <button id="sidebarToggle">‚ò∞</button>
    </nav>
  </header>

  <aside id="sidebar">
    <a href="profile.html">My Profile</a>
    <a href="create-project.html">Projects</a>
    <a href="notifications.html">Notifications</a>
    <!-- <a href="admin.html" id="adminLink">Admin Panel</a> -->
    <button id="logoutBtn">Logout</button>
  </aside>

  <main>
    <h2>Welcome to Collabsphere!</h2>
    <p class="intro">
      Collabsphere is a platform that connects creators, developers, and designers to collaborate on exciting projects together.
      <br><br>
      Whether you‚Äôre a student, freelancer, or entrepreneur ‚Äî you can post your ideas, find team members, and work together remotely.
    </p>

    <section class="features">
      <h3>Key Features</h3>
      <ul>
        <li>Post and discover collaboration projects easily.</li>
        <li>Apply to join teams or create your own projects.</li>
        <li>Built-in profile system to showcase your skills.</li>
        <li>Notifications to stay updated on opportunities.</li>
      </ul>
    </section>

    <section class="cta">
      <h3>Start Exploring</h3>
      <p>
        Go to the <a href="create-project.html">Projects</a> page to view or create new collaboration projects!
      </p>
    </section>

    <hr>
    <section>
      <h3>Active Projects</h3>
      <div id="projectsList"></div>
    </section>
  </main>

  <script>
    const BASE_URL = 'https://collabsphere-09q9.onrender.com';

    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.getElementById('sidebarToggle');
      const adminLink = document.getElementById('adminLink');
      const logoutBtn = document.getElementById('logoutBtn');
      const projectsList = document.getElementById('projectsList');

      // Sidebar toggle
      toggleBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        sidebar.classList.toggle('show');
      });

      // Close sidebar when clicking outside
      document.addEventListener('click', (event) => {
        if (!sidebar.contains(event.target) && !toggleBtn.contains(event.target)) {
          sidebar.classList.remove('show');
        }
      });

      // Hide admin link safely if it's present
      const isAdmin = sessionStorage.getItem('isAdmin') === '1';
      if (adminLink && !isAdmin) {
        adminLink.style.display = 'none';
      }

      // Logout
      logoutBtn.addEventListener('click', async () => {
        try {
          await fetch(`/auth/logout`, { method: 'POST', credentials: 'include' });
        } catch (err) {
          console.error('Logout API error:', err);
        }
        sessionStorage.clear();
        localStorage.clear();
        window.location.href = 'index.html';
      });

      // Load all approved projects
      async function loadProjects() {
        projectsList.innerHTML = '<p>Loading projects‚Ä¶</p>';
        try {
          const res = await fetch(`/api/projects/all`, { credentials: 'include' });
          if (!res.ok) throw new Error('Failed to load projects');
          const projects = await res.json();

          projectsList.innerHTML = '';
          if (!Array.isArray(projects) || projects.length === 0) {
            projectsList.innerHTML = '<p>No active projects found.</p>';
            return;
          }

          projects
            .filter(p => p.status === 'approved') // show only approved projects
            .forEach(p => {
              const div = document.createElement('div');
              div.className = 'project-card';
              div.innerHTML = `
                <h3><a href="project.html?id=${p.id}">${escapeHtml(p.title || 'Untitled')}</a></h3>
                <p>${escapeHtml(p.description || '')}</p>
                <p>Owner: ${escapeHtml(p.owner_name || 'Unknown')}</p>
                <p><strong>${p.required_people || 'N/A'}</strong> members required</p>
                <div class="project-actions">
                  <button class="apply-btn" data-id="${p.id}">Apply</button>
                  <button class="share-btn" data-id="${p.id}">Share</button>
                </div>
                <hr>
              `;
              projectsList.appendChild(div);
            });

          // Button event listeners
          projectsList.addEventListener('click', async (e) => {
            const applyBtn = e.target.closest('.apply-btn');
            const shareBtn = e.target.closest('.share-btn');

            if (applyBtn) {
              const id = applyBtn.getAttribute('data-id');
              await apply(id);
            } else if (shareBtn) {
              const id = shareBtn.getAttribute('data-id');
              copyLink(id);
            }
          });
        } catch (err) {
          console.error('Error loading projects:', err);
          projectsList.innerHTML = '<p style="color:red;">‚ùå Failed to load projects. Please refresh.</p>';
        }
      }

      // Apply to project
      async function apply(id) {
        try {
          const res = await fetch(`/api/projects/apply`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ projectId: id })
          });
          const data = await res.json();
          alert(data.message || data.error || 'Application sent!');
        } catch (err) {
          console.error('Apply error:', err);
          alert('‚ùå Failed to apply. Please try again.');
        }
      }

      // Copy project link
      function copyLink(id) {
        const url = `${window.location.origin}/project.html?id=${id}`;
        navigator.clipboard.writeText(url)
          .then(() => alert('üîó Project link copied!'))
          .catch(err => {
            console.error('Clipboard error:', err);
            prompt('Copy this link:', url);
          });
      }

      // Escape HTML (security)
      function escapeHtml(str) {
        return String(str)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      // Initial load
      loadProjects();
    });
  </script>
</body>
</html>
